/*
 * LiquidBounce Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CCBlueX/LiquidBounce/
 * @author RtxOP
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.FDPClient.hud
import net.ccbluex.liquidbounce.event.*
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.features.value.BoolValue
import net.ccbluex.liquidbounce.ui.client.hud.element.elements.Notification
import net.ccbluex.liquidbounce.ui.client.hud.element.elements.NotifyType

@ModuleInfo("AntiCheatCheck", category = ModuleCategory.EXPLOIT)
object AnticheatDetector : Module() {
    private val debug by BoolValue("Debug", true)

    private val actionNumbers = mutableListOf<Int>()
    private var check = false
    private var ticksPassed = 0

    @EventTarget
    private fun onPacket(event: PacketEvent) {
        val packet = event.packet

        if (packet is net.minecraft.network.play.server.S32PacketConfirmTransaction && check) {
            actionNumbers.add(packet.actionNumber.toInt())

            if (debug) {
                chat("ID: ${packet.actionNumber}")
            }

            if (actionNumbers.size >= 5) {
                analyzeActionNumbers()
                check = false
            }
            ticksPassed = 0
        }
    }

    @EventTarget
    private fun onTick(event: GameTickEvent) {
        if (check) ticksPassed++
        if (ticksPassed > 40 && check) {
            hud.addNotification(Notification("Check","§3Anticheat detection timed out.",NotifyType.INFO, 3000))
            check = false
            actionNumbers.clear()
        }
    }

    @EventTarget
    private fun onWorld(event: WorldEvent) {
        reset()
        if (event.worldClient != null) check = true
    }

    override fun onEnable() {
        reset()
        // if (mc.theWorld != null) hud.addNotification(Notification("§3Anticheat detection started...", 3000F))
    }

    private fun analyzeActionNumbers() {
        if (actionNumbers.size < 3) {
            return
        }

        val differences = mutableListOf<Int>()
        for (i in 1 until actionNumbers.size) {
            differences.add(actionNumbers[i] - actionNumbers[i - 1])
        }

        val allSame = differences.all { it == differences[0] }
        if (allSame) {
            val step = differences[0]
            val first = actionNumbers.first()

            val detectedAC = when (step) {
                1 -> when {
                    first in -23772..-23762 -> "Vulcan"
                    first in 95..105 -> "Matrix"
                    else -> "Verus"
                }
                -1 -> when {
                    first < -3000 -> "Intave"
                    first in -5..0 -> "Grim"
                    first in -3005..-2995 -> "Karhu"
                    else -> "Polar"
                }
                else -> null
            }

            detectedAC?.let {
                hud.addNotification(Notification("Check","§3Anticheat detected: §a${it}",NotifyType.INFO, 3000))
                actionNumbers.clear()
                return
            }
        }

        // Polar
        if (differences.size >= 2) {
            val firstDiff = differences[0]
            val secondDiff = differences[1]
            val remainingDiffs = differences.drop(2)

            if (firstDiff >= 100 && secondDiff == -1 && remainingDiffs.all { it == -1 }) {
                hud.addNotification(Notification("Check","§3Anticheat detected: §aPolar",NotifyType.INFO, 3000))
                actionNumbers.clear()
                return
            }
        }

        // Intave zero handling
        val firstAction = actionNumbers.firstOrNull()
        if (firstAction != null && firstAction < -3000 && actionNumbers.any { it == 0 }) {
            hud.addNotification(Notification("Check","§3Anticheat detected: §aIntave",NotifyType.INFO, 3000))
            actionNumbers.clear()
            return
        }

        hud.addNotification(Notification("Check","§3No known anticheat detected.",NotifyType.INFO, 3000))
        if (debug) {
            chat("§3Action Numbers: ${actionNumbers.joinToString()}")
            chat("§3Differences: ${differences.joinToString()}")
        }
        actionNumbers.clear()
    }

    private fun reset() {
        actionNumbers.clear()
        ticksPassed = 0
        check = false
    }
}